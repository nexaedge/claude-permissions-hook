# Code Review Report

- Report ID: `e823b9936498`
- Project: `claude-permissions-hook`
- Date (UTC): `2026-02-16T23:36:31Z`
- Reviewer: `Codex`

## Executive Summary
The codebase is compact, test-covered, and generally clean. Core risks are around command parsing behavior that can fail open (`{}` no-opinion response), which is important for a permissions/security hook.

## Findings (Prioritized)

### 1. High: Fail-open behavior on parse failure can bypass policy
- Location: `src/command/mod.rs:27`, `src/decision/mod.rs:70`, `src/decision/mod.rs:76`
- Issue:
  - On shell parse error, parser returns an empty list of command segments.
  - Decision logic treats empty/unlisted as `None`, leading to `{}` output (no policy decision).
- Why it matters:
  - In permission hooks, malformed or partially parsed command text should not degrade to no-opinion.
- Reproduction observed:
  - With config: `bash { deny "rm" }`
  - Command: `git add . &&`
  - Result: `{}`
- Recommendation:
  - Change parser API from `Vec<CommandSegment>` to `Result<Vec<CommandSegment>, ParseError>`.
  - In `evaluate`, if parse fails (or command is non-empty but no segments extracted), return restrictive decision (`ask` or `deny`) instead of `None`.

### 2. High: Unsupported AST nodes can produce policy bypass paths
- Location: `src/command/mod.rs:73`, `src/command/mod.rs:101`
- Issue:
  - Function declarations/invocations and some compound commands are skipped/ignored.
  - This can omit dangerous commands from extracted program list.
- Why it matters:
  - Attackers or accidental usage can wrap dangerous commands in unsupported constructs and evade rules.
- Reproduction observed:
  - With config: `bash { deny "rm" }`
  - Command: `f(){ rm -rf /; }; f`
  - Result: `{}`
- Recommendation:
  - Traverse all relevant AST constructs where possible.
  - If a construct cannot be analyzed safely, fail closed (`ask`/`deny`) with explicit reason.

### 3. Medium: README is out of sync with implementation
- Location: `README.md:25`, `README.md:40`, `src/protocol/input.rs:6`, `src/config/mod.rs:32`
- Issue:
  - Example JSON uses snake_case fields, while serde expects camelCase.
  - README says YAML config is planned, but implementation already supports KDL config.
- Why it matters:
  - Users may fail integration due to incorrect docs.
- Recommendation:
  - Update README input examples to camelCase.
  - Update config section to document current KDL format and `--config` usage.

### 4. Low: Validation path is declared but not enforced
- Location: `src/config/mod.rs:29`, `src/config/mod.rs:74`
- Issue:
  - `ValidationError` exists but no validation currently emits it.
  - Conflicting entries across allow/ask/deny are silently accepted by precedence rules.
- Why it matters:
  - Silent config conflicts reduce operator confidence and can hide mistakes.
- Recommendation:
  - Validate overlaps at load/parse time (error or warning).
  - Optionally expose “strict mode” to reject conflicting config.

### 5. Low: Unused dependency in Cargo manifest
- Location: `Cargo.toml:14`
- Issue:
  - `miette` appears unused in source/tests.
- Why it matters:
  - Unused deps increase maintenance and audit surface.
- Recommendation:
  - Remove `miette` if not needed, or integrate for structured diagnostics.

## What Was Verified
- `cargo test` passed.
- `cargo clippy --all-targets --all-features` passed.
- `cargo fmt --check` passed.
- Manual reproduction of the two high-severity bypass scenarios was confirmed.

## Suggested Next Patch Order
1. Parser/evaluation fail-closed behavior.
2. AST coverage for unsupported constructs + tests.
3. Documentation synchronization.
4. Config validation enhancements.
5. Dependency cleanup.

## Response

All 5 findings addressed. 92 tests pass, clippy clean, fmt clean.

### Finding 1: Fail-open on parse failure — Fixed

Agreed completely. Changed `command::parse()` to return `Result<Vec<CommandSegment>, ParseError>`. In `evaluate()`, three new fail-closed checks:
- Empty command string → Ask ("Empty bash command")
- Parse error → Ask ("Failed to parse command: {error}")
- Non-empty command but no segments extracted → Ask ("No programs extracted from command")

Verified: `git add . &&` now returns `ask` with reason "Failed to parse command: syntax error at end of input" instead of `{}`.

### Finding 2: Unsupported AST nodes — Fixed (Function + CaseClause)

Agreed for constructs that contain executable code. Now traversing:
- **Function bodies** — `f(){ rm -rf /; }` now extracts `rm` from the body
- **CaseClause bodies** — `case $x in a) rm -rf /;; esac` now extracts `rm` from each case arm

Left as-is (no programs to extract):
- **ExtendedTest** (`[[ ]]`) — conditional tests, not program execution
- **Arithmetic** (`(( ))`) — math expressions, not program execution

Verified: `f(){ rm -rf /; }; f` now returns `deny` with reason "programs: [rm, f]" instead of `{}`.

Residual risk: a function *invocation* like `f` in the example is still just an unlisted simple command — the hook doesn't track that `f` was defined earlier in the same command. In practice this is minor: the function body itself is now analyzed, so the dangerous program (`rm`) is caught regardless. The aggregation of `deny(rm) + unlisted(f)` correctly yields `deny`.

### Finding 3: README out of sync — Fixed

Rewrote the README:
- Example JSON now uses correct camelCase field names (`toolName`, `permissionMode`, etc.)
- Replaced "YAML planned" with actual KDL config documentation
- Added config format section with example, precedence rules, multi-command behavior
- Added permission mode decision matrix table

### Finding 4: ValidationError unused — Removed (disagree with recommendation)

Removed the dead `ValidationError` variant from `ConfigError` instead of implementing validation. The deny > ask > allow precedence already handles overlaps safely — putting `rm` in both allow and deny results in deny, which is the correct fail-closed behavior. Adding overlap validation would reject configs that work correctly today, which is a breaking change with no safety benefit. If a "strict mode" becomes useful later, we can add it then.

### Finding 5: miette unused — Removed

Removed `miette` from `Cargo.toml`. Confirmed via `cargo tree` it's no longer a direct dependency.

## Notes For Follow-Up Review
If you leave comments in this file, the next report can reference this ID and create a delta review focused on:
- Which findings were addressed,
- Residual risk,
- New regressions or edge cases.
